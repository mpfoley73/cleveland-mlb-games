---
title: "Cleveland Indians Game Duration"
subtitle: "Data Exploration"
author: "Michael Foley"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(tidyverse)
library(lubridate)
library(ggthemes)
library(extrafont)
library(fpp3)
library(tsibble)
library(fable)
library(patchwork) # for arranging plots
library(glue)
library(png)
library(gridGraphics)
library(grid)

cle_colors <- c("navy_blue" = "#0C2340", "red" = "#E31937")
oak_colors <- c("gold" = "#efb21e", "kellygreen" = "#003831")
vintage_colors <- c("#CBBCB1", "#AF6B58", "#556052", "#F2EFEA")
all_colors <- c(cle_colors, oak_colors, vintage_colors)
names(all_colors) <- NULL
```

```{r data}
# Get data from prior step
cle_games <- readRDS("./cle_games.rds")

# Create a time-series tibble (tsibble). 
cle_tsibble <- cle_games %>%
  mutate(game_hours = as.duration(game_duration) / dhours(1),
         # normalize game times to a 9-inning game
         game_hours_norm = game_hours / innings * 9) %>%
  tsibble(key = c(season, doubleheader_game), index = game_date)
```

The Baseball-Reference web site for the [2021 Cleveland Indians](https://www.baseball-reference.com/teams/CLE/2021.shtml) includes a page of game schedule and results with several interesting features. This project will investigate trends in game duration over the team's 120 years of existence. The `game_date` and `game_duration` columns will be important. A few other seem interesting too: `day_night` (when the game was played), `season` and `game_no` within season, standings `rank` and `games_back` (or ahead) of first place team, which game of a `doubleheader_game` if applicable, `runs_scored` and `runs_allowed`, `innings`, and `attendance`.

```{r}
skimr::skim(cle_games)
```

Most features are fully populated. The `attendance` data is somewhat spotty, primarily in the early years and in double-header games (attendance is only recorded for one game of a doubleheader). 

```{r}
cle_tsibble %>%
  index_by(yr = ~ year(.)) %>%
  group_by(yr, doubleheader_game) %>%
  summarize(na_attendance = sum(if_else(is.na(attendance), 1, 0))) %>%
  ggplot(aes(x = yr, y = na_attendance, fill = fct_rev(doubleheader_game))) + 
  geom_col(width = 1.0) +
  scale_fill_manual(values = all_colors[3:1]) +
  scale_x_continuous(breaks = seq(1900, 2030, 10)) +
  theme_light() +
  theme(text = element_text(size = 16, family = "Rockwell Condensed", 
                            color = cle_colors["navy_blue"]),
        panel.grid.minor = element_blank()) +
  labs(title = "Attendance data is spotty until 1930.",
       subtitle = "Games with no recorded attendance (doubleheader game-2 always 0).",
       x = NULL, y = NULL, fill = "Doublehader Game",
       caption = "source: www.baseball-reference.com.")
```

Curious about the attendance data. Do the peaks and troughs correlate with the team's success?

```{r}
cle_games %>% 
  group_by(season) %>%
  summarize(attend = mean(if_else(home_ind == 1, attendance, NA_real_), na.rm = TRUE)) %>%
  mutate(attend = if_else(season == 2020, 0, attend)) %>%
  ggplot(aes(x = season, y = attend)) +
  # geom_point(color = cle_colors["red"]) +
  geom_line(color = cle_colors["red"], na.rm = TRUE) +
  geom_vline(xintercept = c(1920, 1948, 1954, 1995, 1997, 2016), 
             color = cle_colors["navy_blue"], alpha = 0.2, size = 1.5) +
  annotate(
    geom = "curve", x = 1960, y = 28000, xend = 1954, yend = 22000, 
    curvature = .3, arrow = arrow(length = unit(2, "mm")),
    color = cle_colors["navy_blue"]
  ) +
  annotate("text", x = 1960, y = 28000, label = "what happened?", size = 3, 
           hjust = "left", color = cle_colors["navy_blue"]) +
  scale_y_continuous(limits = c(0, NA), labels = scales::comma) +
  scale_x_continuous(breaks = seq(1900, 2030, 10)) +
  theme_light() +
  labs(x = "Season", y = "Fans per Game",
       title = "Fans love a winner... usually.",
       subtitle = "Attendance jumps in World Series years",
       caption = "source: www.baseball-reference.com.") +
  theme(text = element_text(size = 16, family = "Rockwell Condensed", color = cle_colors["navy_blue"]),
        panel.grid.minor = element_blank())
```

Doubleheaders seem to be more common prior to around 1940. Let's take a closer look. Over 50% of baseball games in 1943 were played as part of a doubleheader.

```{r}
ball_png <- png::readPNG("baseball.png", native = TRUE)
ball_grob <- grid::rasterGrob(ball_png, interpolate = FALSE)

cle_tsibble %>%
  mutate(is_dh = if_else(doubleheader_game == 0, 0, 1)) %>%
  index_by(yr = ~ year(.)) %>%
  group_by(yr) %>%
  summarize(dh_pct = sum(is_dh) / n()) %>%
  ggplot(aes(x = yr, y = dh_pct)) +
  geom_line(color = cle_colors["red"], size = 1.25, alpha = 0.6) +
  annotation_custom(ball_grob, xmin = 1859, xmax = +Inf, ymin = .52, ymax = .55) +
  annotate(
    geom = "curve", x = 1953, y = .58, xend = 1946, yend = .56, 
    curvature = .3, arrow = arrow(length = unit(2, "mm")),
    color = cle_colors["navy_blue"], size = 1.25
  ) +
  annotate("text", x = 1955, y = .58, label = "51% in 1943!", size = 3, 
           hjust = "left", color = cle_colors["navy_blue"]) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), 
                     breaks = seq(0, .6, .1), limits = c(0, .6)) +
  scale_x_continuous(breaks = seq(1900, 2030, 10)) +
  theme_light() +
  theme(text = element_text(size = 16, family = "Rockwell Condensed", 
                            color = cle_colors["navy_blue"]),
        panel.grid.minor = element_blank()) +
  labs(title = "Let's play one.",
       subtitle = "Percent of Tribe games that were part of doubleheaders.",
       x = NULL, y = NULL,
       caption = "source: www.baseball-reference.com.")
```

As with the attendance data, game duration data is also frequently unavailable prior to 1930.

```{r}
cle_tsibble %>%
  index_by(yr = ~ year(.)) %>%
  group_by(yr) %>%
  summarize(na_duration = sum(if_else(is.na(game_duration), 1, 0))) %>%
  ggplot(aes(x = yr, y = na_duration)) + 
  geom_col(width = 1.0, fill = cle_colors["red"]) +
  scale_x_continuous(breaks = seq(1900, 2030, 10)) +
  theme_light() +
  theme(text = element_text(size = 16, family = "Rockwell Condensed", 
                            color = cle_colors["navy_blue"]),
        panel.grid.minor = element_blank()) +
  labs(title = "Game duration data is spotty until 1930.",
       subtitle = "Games with no recorded duration.",
       x = NULL, y = NULL,
       caption = "source: www.baseball-reference.com.")
```

## Game Duration

```{r}
cle_tsibble_yr <- cle_tsibble %>%
  # average over the day (in case of doubleheaders)
  index_by(yr = ~ year(.)) %>%
  group_by(season) %>%
  summarize(game_hours_norm = mean(game_hours_norm, na.rm = TRUE)) 
max_avg <- cle_tsibble_yr %>% slice_max(order_by = game_hours_norm) 
max_hrs <- floor(max_avg %>% pull(game_hours_norm))
max_mins <- floor((max_avg %>% pull(game_hours_norm) - max_hrs) * 60)
```

If it seems like Tribe games are taking longer to complete, you are right. The annual average game duration has been increasing since 2003. Prior to 2003, it had briefly fallen from an all-time high of `r glue("{max_hrs} hours {max_mins} minutes")` in `r max_avg %>% pull(season)`. The earliest games took a little over an hour and a half, but by 1920 game times had climbed over two hours. From 1921 to 1945 game times were steady until they rose again after WWII. From 1955 to 1975, game time were again steady, lasting a little over 2.5 hours. Then they began to rise again.

```{r}
cle_tsibble_yr %>%
  ggplot(aes(x = season, y = game_hours_norm)) +
  annotate("rect", 
           xmin = c(1903, 1945, 1975, 2003), 
           xmax = c(1921, 1955, 2000, 2021), 
           ymin = c(0, 0, 0, 0), ymax = c(3.5, 3.5, 3.5, 3.5), 
           fill = "lightgrey", alpha = 0.6) +
  geom_line(color = cle_colors["red"]) +
  scale_y_continuous(limits = c(0, NA)) +
  scale_x_continuous(breaks = seq(1900, 2030, 10)) +
  theme_light() +
  theme(text = element_text(size = 16, family = "Rockwell Condensed", 
                            color = cle_colors["navy_blue"]),
        panel.grid.minor = element_blank()) +
  labs(x = "Season", y = "Hours",
       title = "How long have we been sitting here?",
       subtitle = "Cleveland Indians average game duration, with periods of growth and stability.",
       caption = "source: www.baseball-reference.com.")
```

```{r}
double_header_effect <- cle_tsibble %>%
  mutate(is_doubleheader = if_else(doubleheader_game == 0, "Single", "Twin Bill")) %>%
  # average over the day (in case of doubleheaders)
  index_by(yr = ~ year(.)) %>%
  group_by(season, is_doubleheader) %>%
  summarize(game_hours_norm = mean(game_hours_norm, na.rm = TRUE)) 

double_header_effect_wide <- double_header_effect %>%
  pivot_wider(names_from = is_doubleheader, values_from = game_hours_norm) %>%
  mutate(twin_diff = `Twin Bill` - Single)

```

Doubleheaders have become less common while game times have increased. Is there a negative correlation, perhaps a compensating effect? Let's print the same chart, but control for whether the game is part of a doubleheader. The answer is no, doubleheaders are irrelevant. The average doubleheader game is shorter by all of `r scales::comma(mean(double_header_effect_wide$twin_diff, na.rm = TRUE) * 60 * (-1), accuracy = 1)` minutes.

```{r}
double_header_effect %>%
  ggplot(aes(x = season, y = game_hours_norm, color = is_doubleheader)) +
  annotate("rect", 
           xmin = c(1903, 1945, 1975, 2003), 
           xmax = c(1921, 1955, 2000, 2021), 
           ymin = c(0, 0, 0, 0), ymax = c(3.5, 3.5, 3.5, 3.5), 
           fill = "lightgrey", alpha = 0.6) +
  geom_line() +
  scale_y_continuous(limits = c(0, NA)) +
  scale_x_continuous(breaks = seq(1900, 2030, 10)) +
  scale_color_manual(values = all_colors) +
  theme_light() +
  theme(text = element_text(size = 16, family = "Rockwell Condensed", 
                            color = cle_colors["navy_blue"]),
        panel.grid.minor = element_blank()) +
  labs(x = "Season", y = "Hours",
       title = "Players don't rush through doubleheaders.",
       subtitle = "Cleveland Indians average game duration, with periods of growth and stability.",
       caption = "source: www.baseball-reference.com.")
```

## Duration Trends

Average game duration does not appear to change much within seasons. The apparent increase in March game times below is an artifact of March games not occurring until 1998.

```{r warning=FALSE}
cle_tsibble_mo <- cle_tsibble %>%
  index_by(mo = ~ yearmonth(.)) %>%
  group_by(season) %>%
  summarize(game_hours = mean(game_hours / innings * 9, na.rm = TRUE))

cle_tsibble_mmm <- cle_tsibble %>%
  index_by(mo = ~ month(.)) %>%
  summarize(game_hours = mean(game_hours / innings * 9, na.rm = TRUE)) %>%
  mutate(mo = ym(paste0("9999-", mo))) 

cle_tsibble_mo %>%
#  filter(year(mo) %in% seq(1910, 2020, by = 10)) %>%
  ggplot(aes(x = month(mo, label = TRUE, abbr = TRUE), y = game_hours, 
             group = factor(year(mo)), 
             color = year(mo))) +
  geom_line(show.legend = FALSE, color = cle_colors["red"], alpha = 0.2) +
  geom_line(data = cle_tsibble_mmm, 
            aes(x = month(mo, label = TRUE, abbr = TRUE), y = game_hours),
            show.legend = FALSE) +
  theme_light() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.25)) +
  labs(title = "Game duration does not change much within a season.",
       subtitle = "Average game duration by month of season.", 
       x = NULL, y = NULL,
       caption = "source: www.baseball-reference.com.") +
  theme(text = element_text(size = 16, family = "Rockwell Condensed", color = cle_colors["navy_blue"]),
        panel.grid.minor = element_blank())
```




```{r}
# Break into training and test
cle_train <- cle_tsibble %>% filter(year(game_date) <= 2020)
cle_test <- cle_tsibble %>% filter(yearmonth(game_date) == yearmonth("2021 Apr"))

# Train model
cle_mdl <- cle_train %>%
  # fill_gaps() %>%
  model(mdl_naive = NAIVE(game_hours))

cle_fc <- cle_mdl %>%
  forecast(h = 20)

cle_mdl %>% broom::augment() %>%
  ggplot(aes(x = game_date)) + 
  geom_line(aes(y = game_hours), color = "goldenrod") +
  geom_line(aes(y = .fitted), color = "goldenrod4", linetype = 2) +
  geom_line(data = cle_fc, aes(x = game_date, y = .mean))


# cle_fc %>%
#   autoplot(color = "goldenrod") +
#   autolayer(cle_train, attendance, color = "goldenrod") +
#   theme_light() +
#   theme(legend.position = "none") +
#   labs(title = "20d naive forecast from model fit to CY-2015",
#        caption = "Shaded area is 80%- and 90% confidence interval.",
#        x = "Trading Day", y = "Closing Price")

```

